name: EAS Build and Deploy

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  lint-and-typecheck:
    name: Lint and Type Check
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: ğŸ“š Install dependencies
        run: npm ci

      - name: ğŸ” Run TypeScript check
        run: npx tsc --noEmit

      - name: ğŸ¨ Run linter (if configured)
        run: npm run lint --if-present
        continue-on-error: true

  build-ios:
    name: Build iOS App
    runs-on: ubuntu-latest
    needs: lint-and-typecheck
    if: github.ref == 'refs/heads/main'

    steps:
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: ğŸ”§ Setup Expo and EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: ğŸ“š Install dependencies
        run: npm ci

      - name: ğŸš€ Build iOS app
        run: eas build --platform ios --non-interactive --no-wait
        env:
          EXPO_PUBLIC_SUPABASE_URL: ${{ secrets.EXPO_PUBLIC_SUPABASE_URL }}
          EXPO_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.EXPO_PUBLIC_SUPABASE_ANON_KEY }}

  # Optional: Submit to TestFlight
  # submit-to-testflight:
  #   name: Submit to TestFlight
  #   runs-on: ubuntu-latest
  #   needs: build-ios
  #   if: github.ref == 'refs/heads/main'
  #
  #   steps:
  #     - name: ğŸ“¦ Checkout repository
  #       uses: actions/checkout@v4
  #
  #     - name: ğŸ”§ Setup Expo and EAS
  #       uses: expo/expo-github-action@v8
  #       with:
  #         eas-version: latest
  #         token: ${{ secrets.EXPO_TOKEN }}
  #
  #     - name: ğŸš€ Submit to TestFlight
  #       run: eas submit --platform ios --latest --non-interactive
